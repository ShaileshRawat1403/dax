#!/usr/bin/env node

import childProcess from "node:child_process"
import fs from "node:fs"
import path from "node:path"
import os from "node:os"
import { fileURLToPath } from "node:url"

function run(target, args = process.argv.slice(2)) {
  const result = childProcess.spawnSync(target, args, {
    stdio: "inherit",
  })
  if (result.error) {
    console.error(result.error.message)
    process.exit(1)
  }
  const code = typeof result.status === "number" ? result.status : 0
  process.exit(code)
}

const envPath = process.env.DAX_BIN_PATH
if (envPath) {
  run(envPath)
}

const scriptPath = fs.realpathSync(fileURLToPath(import.meta.url))
const scriptDir = path.dirname(scriptPath)

const platformMap = {
  darwin: "darwin",
  linux: "linux",
  win32: "windows",
}
const archMap = {
  x64: "x64",
  arm64: "arm64",
  arm: "arm",
}

let platform = platformMap[os.platform()]
if (!platform) {
  platform = os.platform()
}
let arch = archMap[os.arch()]
if (!arch) {
  arch = os.arch()
}
const base = "dax-" + platform + "-" + arch
const binary = platform === "windows" ? "dax.exe" : "dax"

function findBinary(startDir) {
  let current = startDir
  for (;;) {
    const modules = path.join(current, "node_modules")
    if (fs.existsSync(modules)) {
      const entries = fs.readdirSync(modules)
      for (const entry of entries) {
        if (!entry.startsWith(base)) {
          continue
        }
        const candidate = path.join(modules, entry, "bin", binary)
        if (fs.existsSync(candidate)) {
          return candidate
        }
      }
    }
    const parent = path.dirname(current)
    if (parent === current) {
      return
    }
    current = parent
  }
}

const resolved = findBinary(scriptDir)
if (!resolved) {
  const devEntry = path.resolve(scriptDir, "../src/index.ts")
  if (fs.existsSync(devEntry)) {
    run("bun", [
      "run",
      "--cwd",
      path.resolve(scriptDir, ".."),
      "--conditions=browser",
      "src/index.ts",
      ...process.argv.slice(2),
    ])
  }
  console.error(
    'It seems that your package manager failed to install the right version of the dax CLI for your platform. You can try manually installing the "' +
      base +
      '" package',
  )
  process.exit(1)
}

run(resolved)
